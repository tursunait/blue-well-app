// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
  // SQLite stores arrays as JSON automatically
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  image           String?
  createdAt       DateTime @default(now())
  // Survey-derived profile (all optional)
  gender          String?
  age             Int?
  heightCm        Float?
  weightKg        Float?
  fitnessGoal     String?   // FitnessGoal enum stored as string
  reminderPref    String?   // ReminderPref enum stored as string
  scheduleCons    Int?      // 1..5
  mealRegular     Int?      // 1..5
  weeklyActivity  Int?      // 1..4
  timeBudgetMin   Int?      // bucket: 10, 20, 40, 60+
  dietPrefs       String?   // JSON array stored as string
  avoidFoods      String?   // JSON array stored as string
  googleCalConnected Boolean @default(false)
  myRecConnected     Boolean @default(false)
  profile         Profile?
  integrations    Integration?
  surveyAnswers   SurveyAnswer[]
  foodLogs        FoodLog[]
  activityLogs    ActivityLog[]
  recommendations Recommendation[]
  mealLogs        MealLog[] // legacy
  aiRecs          AIRec[]
}

// Enums are stored as strings in SQLite
// FitnessGoal: "LOSE_FAT" | "MAINTAIN" | "GAIN_MUSCLE" | "FITNESS" | "ATHLETIC" | "UNKNOWN"
// ReminderPref: "LIGHT" | "BALANCED" | "DAILY" | "NONE"

model Profile {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  age            Int?
  gender         String?
  heightCm       Int?
  weightKg       Float?
  units          String?  // metric/imperial
  primaryGoal    String?
  weeklyWorkouts Int?     // target
  dietPrefs      String? // JSON array stored as string: ["Vegan","Halal"]
  allergies      String? // JSON array stored as string
  budgetWeekly   Int?
  timePrefs      String? // JSON array stored as string: ["morning","evening"]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  @@index([userId])
}

model Integration {
  id            String  @id @default(cuid())
  userId        String  @unique
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  gcalConnected Boolean @default(false)
  gcalToken     String? // encrypted
  myrecConnected Boolean @default(false)
  myrecToken     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SurveyAnswer {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId String
  value      String  // JSON stored as string
  tsISO      DateTime @default(now())
  surveyId   String?  // optional for backward compatibility
  answerJson String?    // JSON stored as string (optional for backward compatibility)
  createdAt  DateTime @default(now())
  @@index([userId, surveyId])
}

model MealLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageUrl   String?
  itemsJson  String?     // JSON stored as string: [{name, kcal, protein, fat, carbs}]
  totalKcal  Int?
  totalMacros String?    // JSON stored as string
  createdAt  DateTime @default(now())
  source     String    // "photo" | "manual"
  @@index([userId, createdAt])
}

model MenuVendor {
  id        String   @id @default(cuid())
  name      String
  source    String   // "DUKE_DINING" | "UBER_EATS" | "DOORDASH" | "GRUBHUB" | "CAMPUS"
  campusLoc String?
  url       String?
  items     MenuItem[]
  @@index([name])
}

model MenuItem {
  id         String   @id @default(cuid())
  vendorId   String
  vendor     MenuVendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name       String
  normalized String   // lowercased, de-punctuated
  description String?
  calories   Int?
  proteinG   Float?
  carbsG     Float?
  fatG       Float?
  priceUSD   Float?
  tags       String?   // JSON array stored as string
  embedding  Bytes?
  updatedAt  DateTime @default(now())
  @@unique([vendorId, normalized])
}

model FitnessClass {
  id        String   @id @default(cuid())
  title     String
  startTime DateTime
  endTime   DateTime
  location  String?
  intensity String? // low/med/high
  url       String?
  source    String   // "DUKE_REC"
  updatedAt DateTime @default(now())
  @@index([startTime])
}

model FoodLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ts        DateTime @default(now())
  source    String   // "PHOTO_AI" | "MANUAL" | "MENU_PICK"
  itemName  String
  restaurant String? // Restaurant/vendor name (e.g., "Marketplace", "Bella Union")
  menuItemId String? // Optional: link to MenuItem if from database
  calories  Int
  proteinG  Float?
  carbsG    Float?
  fatG      Float?
  notes     String?
  @@index([userId, ts])
  @@index([restaurant, itemName])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ts         DateTime @default(now())
  source     String   // "GOOGLE_CAL" | "DUKE_REC" | "MANUAL"
  activity   String   // "Yoga", "Run", "Strength"
  durationMin Int?
  intensity  String?
  kcalBurn   Int?
  @@index([userId, ts])
}

model Recommendation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime @default(now())
  scope     String   // "TODAY" | "NEXT_6_HOURS" | "WEEK"
  payload   String   // JSON stored as string
  rationale String?
  @@index([userId, date])
}

model ClassSlot {
  id        String   @id @default(cuid())
  userId    String?
  title     String
  start     DateTime
  end       DateTime
  location  String?
  spotsOpen Int?
  provider  String    // "myrec"
  rawJson   String?   // JSON stored as string
  createdAt DateTime @default(now())
  @@index([start])
}

model AIRec {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  day       DateTime
  kind      String   // "plan", etc.
  payload   String   // JSON stored as string
  model     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, day, kind])
  @@index([userId, day])
}

