// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  image        String?
  createdAt    DateTime @default(now())
  profile      Profile?
  integrations Integration?
  surveyAnswers SurveyAnswer[]
  mealLogs     MealLog[]
  chatHistory  ChatMessage[]
  dailyPlans   DailyPlan[]
  workoutLogs  WorkoutLog[]
}

model Profile {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  age            Int?
  gender         String?
  heightCm       Int?
  weightKg       Float?
  units          String?  // metric/imperial
  primaryGoal    String?
  weeklyWorkouts Int?     // target
  dietPrefs      String[] // ["Vegan","Halal"]
  allergies      String[]
  budgetWeekly   Int?
  timePrefs      String[] // ["morning","evening"]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  @@index([userId])
}

model Integration {
  id            String  @id @default(cuid())
  userId        String  @unique
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  gcalConnected Boolean @default(false)
  gcalToken     String? // encrypted
  myrecConnected Boolean @default(false)
  myrecToken     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SurveyAnswer {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  surveyId   String
  questionId String
  answerJson Json
  createdAt  DateTime @default(now())
  @@index([userId, surveyId])
}

model MealLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageUrl   String?
  itemsJson  Json?     // [{name, kcal, protein, fat, carbs}]
  totalKcal  Int?
  totalMacros Json?
  createdAt  DateTime @default(now())
  source     String    // "photo" | "manual"
  @@index([userId, createdAt])
}

model ClassSlot {
  id        String   @id @default(cuid())
  userId    String?
  title     String
  start     DateTime
  end       DateTime
  location  String?
  spotsOpen Int?
  provider  String    // "myrec"
  rawJson   Json?
  createdAt DateTime @default(now())
  @@index([start])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   // "user" | "assistant"
  content   String
  metadata  Json?    // Store suggestions, context, etc.
  createdAt DateTime @default(now())
  @@index([userId, createdAt])
}

model DailyPlan {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date
  planJson    Json     // { workouts: [], meals: [], classes: [] }
  isSaved     Boolean  @default(false)
  emailSent   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@unique([userId, date])
  @@index([userId, date])
}

model WorkoutLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  type        String?  // "cardio", "strength", "yoga", etc.
  duration    Int      // minutes
  caloriesBurned Int?
  notes       String?
  date        DateTime @db.Date
  createdAt   DateTime @default(now())
  @@index([userId, date])
}

